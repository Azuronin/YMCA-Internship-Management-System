@model List<IMS.Models.Documents>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Approved Documents";
}

<!-- Required Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-file-alt me-2"></i>Approved Documents</h2>
        <span class="badge bg-primary">
            <i class="fas fa-users me-1"></i>
            @{
                // Count distinct interns with approved docs
                var userCount = Model
                .Where(d => d.Status == "Approved" && d.User != null)
                .GroupBy(d => d.User.UserId)
                .Count();
            }
            @userCount Interns
        </span>
    </div>

    <!-- Search and Filter Section -->
    <div class="card filter-card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6 mb-3 mb-md-0">
                    <label for="searchInput" class="form-label"><i class="fas fa-search me-1"></i>Search:</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search by name or email..." />
                    </div>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                    <label for="documentTypeFilter" class="form-label"><i class="fas fa-filter me-1"></i>Document Type:</label>
                    <select id="documentTypeFilter" class="form-select">
                        <option value="">All Types</option>
                        @{
                            var docTypes = Model
                            .Where(d => d.Status == "Approved")
                            .Select(d => d.DocumentType)
                            .Distinct()
                            .OrderBy(t => t)
                            .ToList();
                        }
                        @foreach (var type in docTypes)
                        {
                            <option value="@type">@type</option>
                        }
                    </select>
                </div>
                <div class="col-md-2 text-md-end">
                    <button id="clearFilters" class="btn btn-outline-secondary mt-md-4">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Cards -->
    <div class="row" id="internsContainer">
        @{
            var groupedByUser = Model
            .Where(d => d.Status == "Approved" && d.User != null)
            .GroupBy(d => d.User.UserId)
            .OrderBy(g => g.First().User.LastName)
            .ToList();
        }

        @if (!groupedByUser.Any())
        {
            <div class="col-12">
                <div class="empty-state text-center py-5">
                    <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
                    <h4>No Approved Documents</h4>
                    <p class="text-muted">When interns have approved documents, they will appear here.</p>
                </div>
            </div>
        }
        else
        {
            @foreach (var group in groupedByUser)
            {
                var user = group.First().User;
                var fullName = $"{user.FirstName} {user.MiddleName} {user.LastName}".Trim();
                var docCount = group.Count();
                var types = string.Join(", ", group.Select(d => d.DocumentType).Distinct().OrderBy(t => t));

                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card document-card h-100"
                         data-userid="@user.UserId"
                         data-name="@fullName.ToLower()"
                         data-email="@user.Email.ToLower()"
                         data-course="@user.Course?.ToLower()"
                         data-types="@string.Join(" ", group.Select(d => d.DocumentType.ToLower()))">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <span class="badge bg-primary">
                                <i class="fas fa-file me-1"></i>@docCount @(docCount == 1 ? "Document" : "Documents")
                            </span>
                            <button class="btn btn-sm btn-outline-primary view-user-docs" data-userid="@user.UserId" title="View Documents">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">@fullName</h5>
                            <div class="user-details">
                                <div class="detail-item">
                                    <i class="fas fa-envelope me-2 text-muted"></i>
                                    <span>@user.Email</span>
                                </div>
                                @if (!string.IsNullOrEmpty(user.Course))
                                {
                                    <div class="detail-item">
                                        <i class="fas fa-graduation-cap me-2 text-muted"></i>
                                        <span>@user.Course</span>
                                    </div>
                                }
                                <div class="detail-item">
                                    <i class="fas fa-file-alt me-2 text-muted"></i>
                                    <span class="document-types">@types</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- Modal to show list of documents -->
<div class="modal fade" id="docsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="userNameTitle">Approved Documents</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="userInfo" class="mb-3 p-3 bg-light rounded"></div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Document Name</th>
                                <th>Type</th>
                                <th>Upload Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documentList">
                            <!-- Filled via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const allDocuments = @Html.Raw(Json.Serialize(Model));
        const documentList = document.getElementById("documentList");
        const searchInput = document.getElementById("searchInput");
        const documentTypeFilter = document.getElementById("documentTypeFilter");
        const clearFilters = document.getElementById("clearFilters");
        const internCards = document.querySelectorAll(".document-card");

        // Filter functionality
        function filterCards() {
            const searchQuery = searchInput.value.toLowerCase();
            const typeQuery = documentTypeFilter.value.toLowerCase();

            internCards.forEach(card => {
                const name = card.getAttribute('data-name') || '';
                const email = card.getAttribute('data-email') || '';
                const course = card.getAttribute('data-course') || '';
                const types = card.getAttribute('data-types') || '';

                let show = true;

                if (searchQuery && !name.includes(searchQuery) &&
                    !email.includes(searchQuery) && !course.includes(searchQuery)) {
                    show = false;
                }

                if (typeQuery && show && !types.includes(typeQuery)) {
                    show = false;
                }

                card.parentElement.style.display = show ? "block" : "none";
            });
        }

        searchInput.addEventListener("input", filterCards);
        documentTypeFilter.addEventListener("change", filterCards);

        clearFilters.addEventListener("click", function () {
            searchInput.value = '';
            documentTypeFilter.value = '';
            filterCards();
        });

        // Document viewing functionality
        document.querySelectorAll(".view-user-docs").forEach(btn => {
            btn.addEventListener("click", function () {
                const userId = this.dataset.userid;
                const userDocs = allDocuments.filter(doc =>
                    doc.user && doc.user.userId == userId && doc.status === "Approved"
                );
                const user = userDocs.length > 0 ? userDocs[0].user : null;

                if (user) {
                    const fullName = `${user.firstName} ${user.middleName || ''} ${user.lastName}`.trim();
                    document.getElementById("userNameTitle").textContent = `Documents - ${fullName}`;

                    let userInfoHtml = `
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${fullName}</h6>
                                <p class="mb-1 text-muted">${user.email}</p>
                                ${user.course ? `<p class="mb-0"><small>Course: ${user.course}</small></p>` : ''}
                            </div>
                            <div class="ms-3">
                                <span class="badge bg-primary">${userDocs.length} Documents</span>
                            </div>
                        </div>
                    `;
                    document.getElementById("userInfo").innerHTML = userInfoHtml;
                }

                documentList.innerHTML = "";

                if (userDocs.length === 0) {
                    documentList.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4 text-muted">
                                <i class="fas fa-folder-open fa-2x mb-2"></i>
                                <p class="mb-0">No approved documents found.</p>
                            </td>
                        </tr>
                    `;
                } else {
                    userDocs.forEach(doc => {
                        const uploadDate = new Date(doc.uploadDate).toLocaleDateString();

                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${doc.fileName}</td>
                            <td><span class="badge bg-info">${doc.documentType}</span></td>
                            <td>${uploadDate}</td>
                            <td>
                                <div class="action-buttons">
                                    <a href="${doc.filePath}" target="_blank" class="btn btn-sm btn-outline-primary" title="View Document">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                    <a href="${doc.filePath}" class="btn btn-sm btn-outline-success" download title="Download Document">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                            </td>
                        `;

                        documentList.appendChild(row);
                    });
                }

                const modal = new bootstrap.Modal(document.getElementById("docsModal"));
                modal.show();
            });
        });
    });
</script>
