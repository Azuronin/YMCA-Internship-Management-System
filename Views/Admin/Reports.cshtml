@model IEnumerable<IMS.Models.InternReport>

@{
    ViewData["Title"] = "Reports & Certification";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var msg = Context.Request.Query["msg"].ToString();

    // Get certificate status from ViewBag
    var internCertificates = ViewBag.InternCertificates as Dictionary<int, IMS.Models.Certificate> ?? new Dictionary<int, IMS.Models.Certificate>();
}
@if (!string.IsNullOrEmpty(msg))
{
    <script>
        alert("@msg");
    </script>
}
<div class="container-fluid">
    <h1 class="h2 mb-4">Reports</h1>
    <!-- Reports Summary Cards -->
    <div class="row mb-4">
        <!-- Total Reports -->
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Reports</h5>
                    <h2 class="card-text">@Model.Count()</h2>
                </div>
            </div>
        </div>

        <!-- Remaining Tasks -->
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Remaining Tasks</h5>
                    <h2 class="card-text">@ViewBag.RemainingTasks</h2>
                </div>
            </div>
        </div>

        <!-- Completed Tasks -->
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Completed Tasks</h5>
                    <h2 class="card-text">@ViewBag.CompletedTasks</h2>
                </div>
            </div>
        </div>

        <!-- Total Interns -->
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Interns</h5>
                    <h2 class="card-text">@ViewBag.Interns?.Count</h2>
                </div>
            </div>
        </div>
    </div>


    <!-- Reports Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Intern Reports</h5>
        </div>
        <div class="card-body">
            @if (!Model.Any())
            {
                <div class="text-center py-5">
                    <i class="fas fa-file-alt display-4 text-muted mb-3"></i>
                    <h5 class="text-muted">No reports submitted yet</h5>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover" id="reportsTable">
                        <thead>
                            <tr>
                                <th>Intern</th>
                                <th>Task</th>
                                <th>Report Type</th>
                                <th>Content Preview</th>
                                <th>Date Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var report in Model.OrderByDescending(r => r.DateSubmitted))
                            {
                                <tr>
                                    <td>
                                        <div class="fw-bold">@report.User?.FirstName @report.User?.LastName</div>
                                        <small class="text-muted">@report.User?.Email</small>
                                    </td>
                                    <td>
                                        <div class="fw-bold">@report.Task?.Title</div>
                                    </td>
                                    <td>
                                        <span class="badge bg-@(report.ReportType == "Task Completion" ? "success" : "info")">
                                            @report.ReportType
                                        </span>
                                    </td>
                                    <td>
                                        @if (report.Content?.Length > 50)
                                        {
                                            @report.Content.Substring(0, 50)
                                            <span>...</span>
                                        }
                                        else
                                        {
                                            @report.Content
                                        }
                                    </td>
                                    <td>
                                        <div>@report.DateSubmitted.ToString("MMM dd, yyyy")</div>
                                        <small class="text-muted">@report.DateSubmitted.ToString("hh:mm tt")</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#viewReportModal-@report.ReportId">
                                            <i class="fas fa-eye me-1"></i>
                                        </button>

                                        <!-- Delete button -->
                                        <form asp-action="DeleteReport" method="post" style="display:inline;">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@report.ReportId" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this report?')" title="Delete Report">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@foreach (var report in Model)
{
    <!-- Reuse modal from MyReports -->
    <div class="modal fade" id="viewReportModal-@report.ReportId" tabindex="-1" aria-labelledby="viewReportModalLabel-@report.ReportId" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewReportModalLabel-@report.ReportId">Report Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Left column -->
                        <div class="col-md-6">
                            <h5 class="fw-bold">@report.Task?.Title</h5>
                            <p><strong>Report Type:</strong> @report.ReportType</p>
                            <p><strong>Submitted:</strong> @report.DateSubmitted.ToString("MMM dd, yyyy hh:mm tt")</p>

                            <div class="mt-4">
                                <h6>Report Content:</h6>
                                <div class="border p-3 bg-light rounded" style="white-space: pre-line;">
                                    @report.Content
                                </div>
                            </div>
                        </div>

                        <!-- Right column -->
                        <div class="col-md-6">
                            <h6>Proof File:</h6>
                            @if (!string.IsNullOrEmpty(report.FilePath))
                            {
                                <div class="text-center">
                                    <a href="@Url.Content(report.FilePath)" target="_blank">
                                        <img src="@Url.Content(report.FilePath)"
                                             class="img-fluid rounded mb-2"
                                             alt="Proof file"
                                             style="max-height:200px; object-fit:cover;"
                                             title="Click to view full image in new tab" />
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-file-alt display-4"></i>
                                    <p class="mt-2">No proof file available</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Certificate Confirmation Modal -->
<div class="modal fade" id="deleteCertificateModal" tabindex="-1" aria-labelledby="deleteCertificateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCertificateModalLabel">Delete Certificate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this certificate? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                <!-- ✅ Make the form visible and styled properly -->
                <form id="deleteCertificateForm" asp-action="DeleteCertificate" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="deleteCertId" />
                    <button type="submit" class="btn btn-danger">Delete Certificate</button>
                </form>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const internSelect = document.getElementById('internSelect');
            const preview = document.getElementById('certificatePreview');
            const viewLink = document.getElementById('viewCertificateLink');
            const buttonText = document.getElementById('buttonText');
            const deleteBtn = document.getElementById('deleteCertificateBtn');
            const deleteCertId = document.getElementById('deleteCertId'); // hidden input in modal
            const deleteModal = document.getElementById('deleteCertificateModal');

            if (!internSelect) {
                console.error('internSelect element not found');
                return;
            }

            // Handle intern selection
            internSelect.addEventListener('change', function () {
                const selected = this.options[this.selectedIndex];

                if (!selected || selected.value === "") {
                    preview.style.display = "none";
                    buttonText.textContent = "Issue Certificate";
                    return;
                }

                const hasCertificate = selected.getAttribute("data-has-certificate") === "True" ||
                                       selected.getAttribute("data-has-certificate") === "true";
                const certPath = selected.getAttribute("data-certificate-path");
                const certId = selected.getAttribute("data-certificate-id");

                if (hasCertificate && certPath) {
                    preview.style.display = "block";
                    viewLink.href = certPath;
                    buttonText.textContent = "Replace Certificate";

                    // Delete button opens modal and sets cert id
                    deleteBtn.onclick = function () {
                        deleteCertId.value = certId;
                        new bootstrap.Modal(deleteModal).show();
                    };
                } else {
                    preview.style.display = "none";
                    buttonText.textContent = "Issue Certificate";
                }
            });

            // Trigger change once to initialize
            internSelect.dispatchEvent(new Event('change'));

            // Form validation for certificate upload
            $('#certificateForm').on('submit', function () {
                const fileInput = document.getElementById('certificateFile');
                if (fileInput.files.length === 0) {
                    alert('Please upload a PDF certificate file.');
                    return false;
                }

                const fileExtension = fileInput.value.toLowerCase().substring(fileInput.value.lastIndexOf('.'));
                if (fileExtension !== '.pdf') {
                    alert('Only PDF files are allowed for certificates.');
                    return false;
                }

                return true;
            });

            // Initialize DataTable for reports table if it exists
            if (typeof $.fn.DataTable !== 'undefined' && document.getElementById('reportsTable')) {
                var table = $('#reportsTable').DataTable({
                    order: [[3, 'desc']],
                    responsive: true,
                    columnDefs: [
                        { orderable: false, targets: [4, 5] }
                    ]
                });

                $('#showOnlyWithFiles').change(function () {
                    if (this.checked) {
                        table.column(4).search('^((?!None).)*$', true, false).draw();
                    } else {
                        table.column(4).search('').draw();
                    }
                });
            }
        });
    </script>
}


<style>
    .card {
        margin-bottom: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .card-title {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .card-text {
        font-size: 1.75rem;
        margin-bottom: 0;
    }

    /* Style for certificate preview */
    #certificatePreview {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
</style>