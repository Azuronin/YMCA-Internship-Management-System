@model (List<IMS.Models.User> PendingUsers, List<IMS.Models.User> ApprovedUsers, List<IMS.Models.User> DisapprovedUsers)

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Manage Users";
    var msg = Context.Request.Query["msg"].ToString();

    var role = Context.Session.GetString("UserRole");   // ✅ get role
    var userId = Context.Session.GetString("UserId");   // ✅ get role
}

<link rel="stylesheet" href="~/css/Admin/mngUsers.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

@if (!string.IsNullOrEmpty(msg))
{
    <div class="alert-container">
        <div class="alert alert-success">
            <span>@msg</span>
            <button type="button" class="alert-close">&times;</button>
        </div>
    </div>
}

<div class="management-container">
    <div class="page-header">
        <h2><i class="fas fa-users-cog"></i> User Management</h2>
        <p>Manage system users, their status, and permissions</p>
    </div>

    <div class="controls-section">
        <div class="search-filters">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="userSearch" placeholder="Search by name or email..." />
            </div>
            <select id="positionFilter" class="filter-select">
                <option value="">All Positions</option>
                <option value="Intern">Intern</option>
                <option value="Trainer">Trainer</option>
            </select>
        </div>
        <button onclick="document.getElementById('addUserModal').style.display='block'" class="btn-primary">
            <i class="fa-solid fa-user-plus"></i> Add New Trainer
        </button>
    </div>

    <!-- Status Tabs -->
    <div class="status-tabs">
        <div class="tab active" data-tab="pending">
            <span>Pending</span>
            <span class="badge" style="background-color: #ffc107; color: #212529;">@Model.PendingUsers.Count</span>
        </div>
        <div class="tab" data-tab="approved">
            <span>Approved</span>
            <span class="badge" style="background-color: #28a745; color: white;">@Model.ApprovedUsers.Count</span>
        </div>
        <div class="tab" data-tab="disapproved">
            <span>Disapproved</span>
            <span class="badge" style="background-color: #dc3545; color: white;">@Model.DisapprovedUsers.Count</span>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Trainer</h3>
                <span class="close" onclick="document.getElementById('addUserModal').style.display='none'">&times;</span>
            </div>
            <form asp-action="AddUser" method="post" onsubmit="return validateAddUserForm()" class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="FirstName">First Name *</label>
                        <input type="text" name="FirstName" id="FirstName" required />
                    </div>
                    <div class="form-group">
                        <label for="LastName">Last Name *</label>
                        <input type="text" name="LastName" id="LastName" required />
                    </div>
                </div>
                <div class="form-group">
                    <label for="Email">Email Address *</label>
                    <input type="email" name="Email" id="Email" required placeholder="user@example.com" pattern="^[\w\.-]+(gmail\.com|ims\.com)$" />
                    <div class="input-note">Only gmail.com or ims.com domains allowed</div>
                </div>
                <div class="form-group">
                    <label for="AddUserPassword">Password *</label>
                    <div class="password-wrapper">
                        <input type="password" name="Password" id="AddUserPassword" required minlength="6" pattern="^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[$!%*?&]).+$" />
                        <i class="fa fa-eye toggle-password" onclick="togglePassword('AddUserPassword', this)"></i>
                    </div>
                    <div class="input-note">Must include uppercase, lowercase, number, and special character</div>
                </div>
                <div class="form-group">
                    <label for="Position">Position *</label>
                    <input type="text" name="Position" id="Position" value="Trainer" readonly class="form-control" />
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('addUserModal').style.display='none'">Cancel</button>
                    <button type="submit" class="btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- USERS TABLE SECTION -->
    <div id="userTables">
        <!-- Pending Users Table -->
        @if (Model.PendingUsers.Any())
        {
            <div id="pendingTable" class="table-container" style="display: none;">
                <div class="table-header">
                    <h3><i class="fas fa-clock"></i> Pending Approval</h3>
                    <span class="table-subtitle">Users waiting for approval</span>
                </div>
                <div class="table-responsive">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Position</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model.PendingUsers)
                            {
                                <tr class="user-row" data-name="@($"{user.FirstName} {user.MiddleName} {user.LastName}")" data-email="@user.Email" data-position="@user.Position">
                                    <td>
                                        <div class="user-info d-flex align-items-center">
                                            <img src="@Url.Content(user.ProfileImagePath)" alt="Profile" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;" />
                                            <div class="user-details">
                                                <div class="user-name fw-semibold">@user.FirstName @user.MiddleName @user.LastName</div>
                                                <div class="user-status pending text-muted small">Pending</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>@user.Email</td>
                                    <td><span class="position-badge">@user.Position</span></td>
                                    <td>
                                        <div class="action-buttons d-flex gap-2">
                                            <form asp-action="Approve" method="post">
                                                <input type="hidden" name="id" value="@user.UserId" />
                                                <button type="submit" class="btn-icon btn-success" title="Approve">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                            <form asp-action="Disapprove" method="post">
                                                <input type="hidden" name="id" value="@user.UserId" />
                                                <button type="submit" class="btn-icon btn-warning" title="Disapprove">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <div id="pendingTable" class="table-container" style="display: none;">
                <div class="empty-state">
                    <i class="fas fa-clock"></i>
                    <h3>No Pending Users</h3>
                    <p>There are no users waiting for approval</p>
                </div>
            </div>
        }

        <!-- Approved Users Table -->
        @if (Model.ApprovedUsers.Any())
        {
            <div id="approvedTable" class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-check-circle"></i> Approved Users</h3>
                    <span class="table-subtitle">Active system users</span>
                </div>
                <div class="table-responsive">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Position</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                // Safely parse ViewBag.User to int
                                int currentUserId = 0;
                                bool isValidUserId = ViewBag.User != null && int.TryParse(ViewBag.User.ToString(), out currentUserId);
                            }
                            @foreach (var user in Model.ApprovedUsers)
                            {
                                <tr class="user-row" data-name="@($"{user.FirstName} {user.MiddleName} {user.LastName}")" data-email="@user.Email" data-position="@user.Position">
                                    <td>
                                        <div class="user-info">
                                            <img src="@Url.Content(user.ProfileImagePath)" alt="Profile" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;" />
                                            <div class="user-details">
                                                <div class="user-name">@user.FirstName @user.MiddleName @user.LastName</div>
                                                <div class="user-status approved">Approved</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>@user.Email</td>
                                    <td><span class="position-badge">@user.Position</span></td>
                                    <td>
                                        <div class="action-buttons">
                                            <button type="button" class="btn-icon btn-info" title="Edit" onclick="document.getElementById('editModal-@user.UserId').style.display='block'">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            @if (!isValidUserId || user.UserId != currentUserId)
                                            {
                                                <form asp-action="Disapprove" method="post">
                                                    <input type="hidden" name="id" value="@user.UserId" />
                                                    <button type="submit" class="btn-icon btn-warning" title="Disapprove">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </form>
                                            }

                                        </div>
                                    </td>
                                </tr>

                                <!-- Edit Modal for each user -->
                                <div id="editModal-@user.UserId" class="modal">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h3>Edit User</h3>
                                            <span class="close" onclick="document.getElementById('editModal-@user.UserId').style.display='none'">&times;</span>
                                        </div>
                                        <form asp-action="EditUser" method="post" enctype="multipart/form-data" class="modal-form">
                                            <input type="hidden" name="UserId" value="@user.UserId" />
                                            <div class="form-group text-center">
                                                <div class="profile-image-container">
                                                    <img src="@Url.Content(user.ProfileImagePath)" id="profilePreview-@user.UserId" alt="Profile Picture" class="profile-preview" />
                                                    <label for="profileUpload-@user.UserId" class="profile-upload-btn">
                                                        <i class="fas fa-camera"></i> Change Photo
                                                    </label>
                                                    <input type="file" name="ProfileImage" id="profileUpload-@user.UserId" accept=".jpg,.jpeg,.png,.gif,.webp" onchange="previewImage(this, 'profilePreview-@user.UserId')" style="display: none;" />
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label>First Name *</label>
                                                    <input type="text" name="FirstName" value="@user.FirstName" required />
                                                </div>
                                                <div class="form-group">
                                                    <label>Middle Name</label>
                                                    <input type="text" name="MiddleName" value="@user.MiddleName" />
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label>Last Name *</label>
                                                    <input type="text" name="LastName" value="@user.LastName" required />
                                                </div>
                                                <div class="form-group">
                                                    <label>Position</label>
                                                    @if (user.Position == "Intern")
                                                    {
                                                        <div class="readonly-field">Intern</div>
                                                        <input type="hidden" name="Position" value="Intern" readonly />
                                                    }
                                                    else
                                                    {
                                                        <input type="text" name="Position" value="Trainer" readonly class="form-control" />
                                                    }
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>Address</label>
                                                <input type="text" name="Address" value="@user.Address" placeholder="Enter full address..." />
                                            </div>
                                            <div class="form-group">
                                                <label>Email *</label>
                                                <input type="email" name="Email" value="@user.Email" required/>
                                            </div>
                                            @if ((role == "Admin" && user.Position != "Intern")
                                           || (role == "Trainer" && user.UserId == currentUserId))
                                            {
                                                <div class="form-group password-group">
                                                    <label>New Password *</label>
                                                    <div class="password-wrapper">
                                                        <input type="password"
                                                               name="NewPassword"
                                                               id="password-@user.UserId"
                                                               placeholder="Enter new password"
                                                               pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$!%*?&])[A-Za-z\d$!%*?&]{8,}$"
                                                               title="Password must be at least 8 characters long, contain uppercase, lowercase, number, and special character." />
                                                        <span class="toggle-password"
                                                              onclick="togglePassword('password-@user.UserId', this.querySelector('i'))">
                                                            <i class="fas fa-eye"></i>
                                                        </span>
                                                    </div>
                                                    <small class="form-text text-muted">
                                                        Leave blank if you don’t want to change the password.<br />
                                                        Must include uppercase, lowercase, number, and special character.
                                                    </small>
                                                </div>
                                            }

                                            <div class="modal-actions">
                                                    <button type="button" class="btn-secondary" onclick="document.getElementById('editModal-@user.UserId').style.display='none'">Cancel</button>
                                                    <button type="submit" class="btn-primary">Save Changes</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <div id="approvedTable" class="table-container">
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <h3>No Approved Users</h3>
                    <p>There are no approved users in the system</p>
                </div>
            </div>
        }
        <!-- Disapproved Users Table -->
        @if (Model.DisapprovedUsers.Any())
        {
            <div id="disapprovedTable" class="table-container" style="display: none;">
                <div class="table-header">
                    <h3><i class="fas fa-times-circle"></i> Disapproved Users</h3>
                    <span class="table-subtitle">Users who have been disapproved</span>
                </div>
                <div class="table-responsive">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Position</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model.DisapprovedUsers)
                            {
                                <tr class="user-row" data-name="@($"{user.FirstName} {user.MiddleName} {user.LastName}")" data-email="@user.Email" data-position="@user.Position">
                                    <td>
                                        <div class="user-info">
                                            <img src="@Url.Content(user.ProfileImagePath)" alt="Profile" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;" />
                                            <div class="user-details">
                                                <div class="user-name">@user.FirstName @user.MiddleName @user.LastName</div>
                                                <div class="user-status disapproved">Disapproved</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>@user.Email</td>
                                    <td><span class="position-badge">@user.Position</span></td>
                                    <td>
                                        <div class="action-buttons">
                                            <form asp-action="Approve" method="post">
                                                <input type="hidden" name="id" value="@user.UserId" />
                                                <button type="submit" class="btn-icon btn-success" title="Approve">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                            <form asp-action="Delete" method="post">
    <input type="hidden" name="id" value="@user.UserId" />
    <button type="submit" class="btn-icon btn-danger" title="Delete"
            onclick="return confirm('Are you sure you want to delete this account?');">
        <i class="fas fa-trash-alt"></i>
    </button>
</form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <div id="disapprovedTable" class="table-container" style="display: none;">
                <div class="empty-state">
                    <i class="fas fa-times-circle"></i>
                    <h3>No Disapproved Users</h3>
                    <p>There are no disapproved users</p>
                </div>
            </div>
        }

    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content image-modal-content">
            <span class="close" onclick="closeImageModal()">&times;</span>
            <img id="modalImage" src="" class="modal-image" />
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // ✅ Password toggle
        function togglePassword(inputId, iconElement) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                iconElement.classList.remove('fa-eye');
                iconElement.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                iconElement.classList.remove('fa-eye-slash');
                iconElement.classList.add('fa-eye');
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const searchInput = document.getElementById("userSearch");
            const positionFilter = document.getElementById("positionFilter");
            const tabs = document.querySelectorAll(".status-tabs .tab");
            const tables = {
                approved: document.getElementById("approvedTable"),
                pending: document.getElementById("pendingTable"),
                disapproved: document.getElementById("disapprovedTable"),
                deleted: document.getElementById("deletedTable")
            };
            let currentTab = "approved";

            // ✅ Switch table view by tab
            function showTable(selected) {
                currentTab = selected;
                Object.entries(tables).forEach(([key, table]) => {
                    if (!table) return;
                    table.style.display = (key === selected) ? "" : "none";
                });
                tabs.forEach(t => {
                    t.classList.toggle("active", t.dataset.tab === selected);
                });
                filterRows();
            }

            // ✅ Filter rows by name/email/position
            function filterRows() {
                const keyword = searchInput?.value.toLowerCase() || "";
                const position = positionFilter?.value || "";
                const currentTable = tables[currentTab];
                if (!currentTable) return;
                const rows = currentTable.querySelectorAll(".user-row");
                rows.forEach(row => {
                    const name = row.dataset.name?.toLowerCase() || "";
                    const email = row.dataset.email?.toLowerCase() || "";
                    const userPosition = row.dataset.position || "";
                    const matches = (name.includes(keyword) || email.includes(keyword)) &&
                                    (!position || userPosition === position);
                    row.style.display = matches ? "" : "none";
                });
            }

            // ✅ Preview profile image
            function previewImage(input, previewId) {
                const preview = document.getElementById(previewId);
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => preview.src = e.target.result;
                    reader.readAsDataURL(file);
                }
            }
            window.previewImage = previewImage;

            // ✅ Image modal open/close
            function openImageModal(userId, imageUrl) {
                const modal = document.getElementById("imageModal");
                const modalImg = document.getElementById("modalImage");
                modalImg.src = imageUrl;
                modal.style.display = "block";
            }
            window.openImageModal = openImageModal;

            function closeImageModal() {
                document.getElementById("imageModal").style.display = "none";
            }
            window.closeImageModal = closeImageModal;

            // ✅ Add user form validation
            function validateAddUserForm() {
                const email = document.getElementById("Email").value;
                const password = document.getElementById("AddUserPassword").value;

                // Email check
                if (!email.endsWith("gmail.com") && !email.endsWith("ims.com")) {
                    alert("Only gmail.com or ims.com emails are allowed");
                    return false;
                }

                // Password strength check
                const hasUpper = /[A-Z]/.test(password);
                const hasLower = /[a-z]/.test(password);
                const hasNumber = /\d/.test(password);
                const hasSpecial = /[$!%*?&]/.test(password);

                if (password.length < 8 || !hasUpper || !hasLower || !hasNumber || !hasSpecial) {
                    alert("Password must have at least 8 characters, including one uppercase letter, one lowercase letter, one number, and one special character ($!%*?&)");
                    return false;
                }
                return true;
            }
            window.validateAddUserForm = validateAddUserForm;

            // ✅ Auto-capitalize first letter of First Name & Last Name
            function autoCapitalize(input) {
                input.addEventListener("input", function () {
                    if (this.value.length > 0) {
                        this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1).toLowerCase();
                    }
                });
            }

            const firstNameInputs = document.querySelectorAll("input[name='FirstName']");
            const lastNameInputs = document.querySelectorAll("input[name='LastName']");
            firstNameInputs.forEach(input => autoCapitalize(input));
            lastNameInputs.forEach(input => autoCapitalize(input));

            // ✅ Event listeners
            if (searchInput) searchInput.addEventListener("input", filterRows);
            if (positionFilter) positionFilter.addEventListener("change", filterRows);
            if (tabs.length) {
                tabs.forEach(tab => {
                    tab.addEventListener("click", () => showTable(tab.dataset.tab));
                });
            }

            // ✅ Initial load: show Approved tab
            showTable("approved");
        });
    </script>
}
