@model IEnumerable<IMS.Models.InternReport>

@{
    ViewData["Title"] = "My Reports & Certificate";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var msg = Context.Request.Query["msg"].ToString();
    ViewBag.Certificate = true;
}

<div class="container-fluid">
    <h1 class="h2 mb-4">My Reports & Certificate</h1>
    @if (!string.IsNullOrEmpty(msg))
    {
        <script>
            alert("@msg");
        </script>
    }
    <!-- Certificate Download Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">
                                <i class="fas fa-certificate text-warning me-2"></i> Internship Certificate
                            </h5>
                            <p class="card-text mb-0">
                                Download your internship completion certificate issued by YMCA Cebu Philippines
                            </p>
                        </div>
                        <div>
                            @if ((bool?)ViewBag.Certificate == true)
                            {
                                <div class="d-flex gap-2">
                                    <!-- Button to open modal and load certificate preview -->
                                    <a href="javascript:void(0)" class="btn btn-success" onclick="showCertificateModal()">
                                        <i class="fas fa-download me-1"></i> Generate Certificate
                                    </a>
                                </div>
                            }
                            else
                            {
                                <button class="btn btn-outline-secondary" disabled>
                                    <i class="fas fa-clock me-1"></i> Certificate Pending
                                </button>
                                <small class="text-muted d-block mt-1">
                                    Your certificate will be available after you complete your hours.
                                </small>
                            }

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Certificate Modal -->
    <div class="modal fade" id="certificateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-certificate text-warning me-2"></i> Internship Certificate
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <iframe id="certificateFrame" src="" width="100%" height="500px" style="border: none;"></iframe>
                </div>
                <div class="modal-footer">
                    <a id="downloadBtn" href="@Url.Action("DownloadCertificate", "Intern")" class="btn btn-primary" target="_blank">
                        <i class="fas fa-file-pdf me-1"></i> Download PDF
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Reports</h5>
                    <h2 class="card-text">@Model.Count()</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Remaining Tasks</h5>
                    <h2 class="card-text">@ViewBag.AvailableTasks?.Count</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Completed Task</h5>
                    <h2 class="card-text">@ViewBag.CompletedCount</h2>
                </div>
            </div>
        </div>

    </div>

    <!-- Reports Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Submitted Reports</h5>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitReportModal">
                <i class="fas fa-plus me-1"></i> Submit New Report
            </button>
        </div>
        <div class="card-body">
            @if (!Model.Any())
            {
                <div class="text-center py-5">
                    <i class="fas fa-file-alt display-4 text-muted mb-3"></i>
                    <h5 class="text-muted">No reports submitted yet</h5>
                    <p class="text-muted">Submit your first report with image proof to track your progress</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover" id="reportsTable">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Report Type</th> <!-- NEW -->
                                <th>Content Preview</th>
                                <th>Date Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var report in Model.OrderByDescending(r => r.DateSubmitted))
                            {
                                <tr>
                                    <td>
                                        <div class="fw-bold">@report.Task?.Title</div>
                                    </td>
                                    <td>
                                        <span class="badge bg-@(report.ReportType == "Task Completion" ? "success" : "info")">
                                            @report.ReportType
                                        </span>
                                    </td>
                                    <td>
                                        @if (report.Content?.Length > 50)
                                        {
                                            @report.Content.Substring(0, 50)
                                            <span>...</span>
                                        }
                                        else
                                        {
                                            @report.Content
                                        }
                                    </td>
                                    <td>
                                        <div>@report.DateSubmitted.ToString("MMM dd, yyyy")</div>
                                        <small class="text-muted">@report.DateSubmitted.ToString("hh:mm tt")</small>
                                    </td>
                                    <td>
                                        <!-- View button -->
                                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#viewReportModal-@report.ReportId">
                                            <i class="fas fa-eye"></i>
                                        </button>

                                        <!-- Edit button -->
                                        <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#editReportModal-@report.ReportId">
                                            <i class="fas fa-edit"></i>
                                        </button>

                                        <!-- Delete button -->
                                        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteReportModal-@report.ReportId">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Submit Report Modal -->
<div class="modal fade" id="submitReportModal" tabindex="-1" aria-labelledby="submitReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="SubmitReport" method="post" enctype="multipart/form-data" id="reportForm">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="submitReportModalLabel">Submit New Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Task *</label>
                        <select class="form-select" name="taskId" required>
                            <option value="">-- Select a task --</option>
                            @if (ViewBag.AvailableTasks != null)
                            {
                                foreach (var task in ViewBag.AvailableTasks)
                                {
                                    <option value="@task.TaskId">@task.Title - Due: @task.DueDate.ToString("MMM dd, yyyy")</option>
                                }
                            }
                        </select>
                        <small class="form-text text-muted">Only tasks with "In Progress" status are shown</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Report Type *</label>
                        <select class="form-select" name="reportType" required>
                            <option value="">-- Select Report Type --</option>
                            <option value="Task Report">Task Report</option>
                            <option value="Task Completion">Task Completion</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Report Content *</label>
                        <textarea class="form-control" name="reportContent" rows="4" placeholder="Describe your progress, findings, or any issues encountered..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Image Proof *</label>
                        <input type="file" class="form-control" name="reportFile" accept=".jpg,.jpeg,.png,.pdf,.gif,.bmp,.webp" required>
                        <div class="form-text">Please upload an image as proof of task completion. Accepted formats: JPG, JPEG, PNG, PDF, GIF, BMP, WEBP</div>
                        <div id="imagePreview" class="mt-2 text-center" style="display: none;">
                            <img id="previewImg" class="img-thumbnail" style="max-height: 200px;">
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Submitting a report with image proof will mark the associated task as completed.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Report</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Per-report modals -->
@foreach (var report in Model)
{
    <!-- View Report Modal -->
    <div class="modal fade" id="viewReportModal-@report.ReportId" tabindex="-1" aria-labelledby="viewReportModalLabel-@report.ReportId" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewReportModalLabel-@report.ReportId">Report Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Left column -->
                        <div class="col-md-6">
                            <h5 class="fw-bold">@report.Task?.Title</h5>
                            <p><strong>Report Type:</strong> @report.ReportType</p>
                            <p><strong>Submitted:</strong> @report.DateSubmitted.ToString("MMM dd, yyyy hh:mm tt")</p>

                            <div class="mt-4">
                                <h6>Report Content:</h6>
                                <div class="border p-3 bg-light rounded" style="white-space: pre-line;">
                                    @report.Content
                                </div>
                            </div>
                        </div>

                        <!-- Right column -->
                        <div class="col-md-6">
                            <h6>Proof File:</h6>
                            @if (!string.IsNullOrEmpty(report.FilePath))
                            {
                                <div class="text-center">
                                    <a href="@Url.Content(report.FilePath)" target="_blank">
                                        <img src="@Url.Content(report.FilePath)"
                                             class="img-fluid rounded mb-2"
                                             alt="Current image"
                                             style="max-height:200px; object-fit:cover;"
                                             title="Click to view full image in new tab" />
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-file-alt display-4"></i>
                                    <p class="mt-2">No proof file available</p>
                                </div>
                            }

                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

   <!-- Edit Report Modal -->
<div class="modal fade" id="editReportModal-@report.ReportId" tabindex="-1" aria-labelledby="editReportModalLabel-@report.ReportId" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="EditReport" method="post" enctype="multipart/form-data" class="edit-report-form">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@report.ReportId" />

                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 class="modal-title" id="editReportModalLabel-@report.ReportId">✏️ Edit Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <!-- Task title -->
                    <div class="mb-3">
                        <label class="form-label">Task</label>
                        <input type="text" class="form-control" value="@report.Task?.Title" readonly>
                        <small class="form-text text-muted">Task cannot be changed after report submission</small>
                    </div>
                        <!-- Report type -->
                        <div class="mb-3">
                            <label class="form-label">Report Type</label>
                            <input type="text" class="form-control" name="reportType" value="@report.ReportType" readonly>
                        </div>

                    <!-- Report content -->
                    <div class="mb-3">
                        <label class="form-label">Report Content *</label>
                        <textarea class="form-control" name="content" rows="6" required>@report.Content</textarea>
                    </div>

                    <!-- File upload -->
                    <div class="mb-3">
                        <label class="form-label">Proof File</label>

                        @if (!string.IsNullOrEmpty(report.FilePath))
                        {
                                <div class="text-center">
                                    <a href="@Url.Content(report.FilePath)" target="_blank">
                                        <img src="@Url.Content(report.FilePath)"
                                             class="img-fluid rounded mb-2"
                                             alt="Current image"
                                             style="max-height:200px; object-fit:cover;"
                                             title="Click to view full image in new tab" />
                                    </a>
                                </div>
                        }

                        <input type="file" class="form-control" name="reportFile" accept=".jpg,.jpeg,.png,.pdf,.gif,.bmp,.webp">
                        <div class="form-text">Upload a new file if you want to replace the existing proof</div>

                        <!-- Live Preview (only when new file is chosen) -->
                        <div class="edit-image-preview mt-3 text-center" style="display: none;">
                            <img class="img-thumbnail" style="max-height: 150px;">
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">💾 Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Delete Report Modal -->
    <div class="modal fade" id="deleteReportModal-@report.ReportId" tabindex="-1" aria-labelledby="deleteReportModalLabel-@report.ReportId" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteReportModalLabel-@report.ReportId">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this report for task: <strong>@report.Task?.Title</strong>?</p>
                    <p class="text-muted">Submitted on: @report.DateSubmitted.ToString("MMM dd, yyyy hh:mm tt")</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Deleting this report will change the task status back to "In Progress".
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form asp-action="DeleteReport" method="post" style="display:inline;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@report.ReportId" />
                        <button type="submit" class="btn btn-danger">Delete Report</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        function showCertificateModal() {
            const iframe = document.getElementById("certificateFrame");
            iframe.src = "@Url.Action("PreviewCertificate", "Intern")";
            const modal = new bootstrap.Modal(document.getElementById("certificateModal"));
            modal.show();
        }
        // Initialize DataTable for reports table
        $(document).ready(function () {
            $('#reportsTable').DataTable({
                order: [[2, 'desc']], // Sort by date submitted descending by default
                responsive: true,
                columnDefs: [
                    { orderable: false, targets: [4] } // Disable sorting on actions column
                ]
            });

            // Image preview for new report form
            $('input[name="reportFile"]').on('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#previewImg').attr('src', e.target.result);
                        $('#imagePreview').show();
                    }
                    reader.readAsDataURL(file);
                }
            });

            // Image preview for edit report forms
            $('.edit-report-form input[name="reportFile"]').on('change', function() {
                const file = this.files[0];
                const preview = $(this).siblings('.edit-image-preview').find('img');
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.attr('src', e.target.result);
                        $(this).siblings('.edit-image-preview').show();
                    }.bind(this);
                    reader.readAsDataURL(file);
                }
            });

            // Form validation
            $('#reportForm').on('submit', function() {
                const fileInput = $('input[name="reportFile"]')[0];
                if (fileInput.files.length === 0) {
                    alert('Please upload an image as proof of task completion.');
                    return false;
                }

                // Validate file type
                const allowedExtensions = ['.jpg', '.jpeg', '.png', '.pdf', '.gif', '.bmp', '.webp'];
                const fileExtension = fileInput.value.toLowerCase().substring(fileInput.value.lastIndexOf('.'));
                if (!allowedExtensions.includes(fileExtension)) {
                    alert('Only image files are allowed (JPG, JPEG, PNG, PDF, GIF, BMP, WEBP).');
                    return false;
                }

                return true;
            });
        });
    </script>
}

<style>
    .card {
        margin-bottom: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .card-title {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .card-text {
        font-size: 1.75rem;
        margin-bottom: 0;
    }

    .img-thumbnail {
        max-width: 100%;
        height: auto;
    }

    /* Style for certificate buttons */
    .btn-info {
        background-color: #0dcaf0;
        border-color: #0dcaf0;
    }

        .btn-info:hover {
            background-color: #31d2f2;
            border-color: #25cff2;
        }
</style>